// Last time updated at 16 Feb 2014, 10:32:23

// Muaz Khan         - www.MuazKhan.com
// MIT License       - www.WebRTC-Experiment.com/licence
// Documentation     - www.RTCMultiConnection.org/docs/

// FAQ               - www.RTCMultiConnection.org/FAQ/
// Development News  - trello.com/b/8bhi1G6n/RTCMultiConnection

// v1.6 changes log  - www.RTCMultiConnection.org/changes-log/#v1.6
// _______________________
// RTCMultiConnection-v1.6

(function(){function e(e){function r(r){if(!r.data.size)r.data=JSON.parse(r.data);if(r.data.type==="text"){n.receive(r.data,r.userid,r.extra)}else if(typeof r.data.maxChunks!="undefined"){t.receive(r.data)}else{if(e.autoTranslateText){r.original=r.data;e.Translator.TranslateText(r.data,function(t){r.data=t;e.onmessage(r)})}else e.onmessage(r)}}function s(t){if(e.onNewSession){t.join=function(n){if(!n)return e.join(t);var r=e.dontAttachStream;e.dontAttachStream=false;captureUserMedia(function(){e.join(t);e.dontAttachStream=r},n)};return e.onNewSession(t)}if(e.joinedARoom)return;e.joinedARoom=true;e.join(t)}function v(t){for(var n=0;n<e.__attachStreams.length;n++){var r=e.__attachStreams[n].streamid;if(e.streams[r])e.streams[r].socket=t}e.__attachStreams=[]}function g(t){function p(e){if(!(e.readyState<=HTMLMediaElement.HAVE_CURRENT_DATA||e.paused||e.currentTime<=0)){g(e)}else setTimeout(function(){p(e)},50)}function g(n){var r=t.stream;r.onended=function(){e.onstreamended(i)};var i={mediaElement:n,stream:r,streamid:r.streamid,session:e.session,blobURL:n.mozSrcObject||n.src,type:"remote",extra:t.extra,userid:t.userid};e.streams[r.streamid]=e._getStream({stream:r,userid:t.userid,streamid:r.streamid,socket:s,type:"remote",streamObject:i,mediaElement:n,rtcMultiConnection:e});e.onstream(i);O();if(e.onspeaking){var o=new d({context:e._audioContext,root:e,event:i});o.connectToSource(r)}}function y(n){t.channel=n;e.channels[t.userid]={channel:t.channel,send:function(t){e.send(t,this.channel)}};e.onopen({extra:t.extra,userid:t.userid});for(var r in e.fileQueue){e.send(e.fileQueue[r],n)}if(w(e.session))O()}function A(){if(s.userid==t.userid)return;s.userid=t.userid;l[t.socketIndex]=s;e.peers[t.userid]={socket:s,peer:f,userid:t.userid,addStream:function(t){e.addStream(t,this.socket)},renegotiate:function(t){e.renegotiate(t)},changeBandwidth:function(t){if(!t)throw"You MUST pass bandwidth object.";if(typeof t=="string")throw"Pass object for bandwidth instead of string; e.g. {audio:10, video:20}";this.peer.bandwidth=t;this.socket.send({userid:e.userid,extra:e.extra||{},changeBandwidth:true,bandwidth:t})},sendCustomMessage:function(t){this.socket.send({userid:e.userid,extra:e.extra||{},customMessage:true,message:t})},onCustomMessage:function(e){S('Received "private" message from',this.userid,typeof e=="string"?e:N(e))},drop:function(t){for(var n in e.streams){if(e._skip.indexOf(n)==-1){n=e.streams[n];if(n.userid==e.userid&&n.type=="local"){this.peer.connection.removeStream(n.stream);e.onstreamended(n.streamObject)}if(n.type=="remote"&&n.userid==this.userid){e.onstreamended(n.streamObject)}}}!t&&this.socket.send({userid:e.userid,extra:e.extra||{},drop:true})},hold:function(){this.peer.hold=true;this.socket.send({userid:e.userid,extra:e.extra||{},hold:true})},unhold:function(){this.peer.hold=false;this.socket.send({userid:e.userid,extra:e.extra||{},unhold:true})},fireHoldUnHoldEvents:function(t){for(var n in e.streams){if(e._skip.indexOf(n)==-1){n=e.streams[n];if(n.userid==e.userid&&n.type=="local"){this.peer.connection.removeStream(n.stream)}if(t&&e.onhold)e.onhold(n.streamObject);if(t&&e.onunhold)e.onunhold(n.streamObject)}}}}}function O(){if(e.userType&&e.direction!=="many-to-many")return;if(!e.session.oneway&&!e.session.broadcast&&e.isInitiator&&C(c)>1&&C(c)<=e.maxParticipantsAllowed){P.send({newParticipant:t.userid||s.channel,userid:u.userid,extra:t.extra||{}})}}function _(n){if(n.userid==e.userid)return;if(n.sdp){t.userid=n.userid;t.extra=n.extra||{};t.renegotiate=n.renegotiate;t.streaminfo=n.streaminfo;D(JSON.parse(n.sdp),n.labels)}if(n.candidate){f&&f.addIceCandidate({sdpMLineIndex:n.candidate.sdpMLineIndex,candidate:JSON.parse(n.candidate.candidate)})}if(n.mute||n.unmute){if(n.promptMuteUnmute){if(n.mute)e.streams[n.streamid].mute(n.session);if(n.unmute)e.streams[n.streamid].unmute(n.session)}else{if(e.streams[n.streamid])n.mediaElement=e.streams[n.streamid].mediaElement;if(n.mute)e.onmute(n);if(n.unmute)e.onunmute(n)}}if(n.stopped){if(e.streams[n.streamid])n.mediaElement=e.streams[n.streamid].mediaElement;e.onstreamended(n)}if(n.promptStreamStop&&!e.isInitiator){T("What if initiator invoked stream.stop for remote user?")}if(n.left){if(m){var r=n.userid;for(var i in e.streams){i=e.streams[i];if(i.userid==r){M(i);i.stream.onended(i.streamObject)}}}if(f&&f.connection){f.connection.close();f.connection=null}if(n.closeEntireSession){e.close();e.refresh()}else if(s&&n.ejected){s.send({left:true,extra:e.extra,userid:u.userid});if(l[t.socketIndex])delete l[t.socketIndex];if(a[s.channel])delete a[s.channel];s=null}e.remove(n.userid);if(c[n.userid])delete c[n.userid];e.onleave({userid:n.userid,extra:n.extra});if(e.userType)e.busy=false}if(n.playRoleOfBroadcaster){if(n.extra){e.extra=L(e.extra,n.extra)}setTimeout(e.playRoleOfInitiator,2e3)}if(n.isCreateDataChannel){if(m){f.createDataChannel()}}if(n.changeBandwidth){if(!e.peers[n.userid])throw"No such peer exists.";e.peers[n.userid].peer.bandwidth=n.bandwidth;e.peers[n.userid].renegotiate()}if(n.customMessage){if(!e.peers[n.userid])throw"No such peer exists.";e.peers[n.userid].onCustomMessage(n.message)}if(n.drop){if(!e.peers[n.userid])throw"No such peer exists.";e.peers[n.userid].drop(true);e.peers[n.userid].renegotiate();e.ondrop(n.userid)}if(n.hold){if(!e.peers[n.userid])throw"No such peer exists.";e.peers[n.userid].peer.hold=true;e.peers[n.userid].renegotiate()}if(n.unhold){if(!e.peers[n.userid])throw"No such peer exists.";e.peers[n.userid].peer.hold=false;e.peers[n.userid].renegotiate()}}function D(n,r){function o(){f.recreateAnswer(n,e.session,function(e,t){x({sdp:e,socket:s,streaminfo:t})})}S(n.type,n.sdp);if(n.type=="answer"){f.setRemoteDescription(n);A();return}if(!t.renegotiate&&n.type=="offer"){h.offerDescription=n;h.session=e.session;if(!f)f=new i;f.create("answer",h);A();return}e.session=t.renegotiate;b(r,f.connection);if(e.session.oneway||w(e.session)){o()}else{if(t.capturing)return;t.capturing=true;e.captureUserMedia(function(e){t.capturing=false;f.connection.addStream(e);o()},t.renegotiate)}delete t.renegotiate}var n={channel:t.channel,onmessage:_,onopen:function(r){if(r)s=r;if(o&&!f){h.session=e.session;if(!f)f=new i;f.create("offer",h)}t.socketIndex=s.index=l.length;a[n.channel]=s;l[t.socketIndex]=s;v(s)}};n.callback=function(e){s=e;n.onopen()};var s=e.openSignalingChannel(n),o=t.isofferer,f;var h={onopen:y,onicecandidate:function(t){if(!e.candidates)throw"ICE candidates are mandatory.";if(!e.candidates.host&&t.candidate.indexOf("typ host")!=-1)return;if(!e.candidates.relay&&t.candidate.indexOf("relay")!=-1)return;if(!e.candidates.reflexive&&t.candidate.indexOf("srflx")!=-1)return;S(t.candidate);s&&s.send({userid:u.userid,candidate:{sdpMLineIndex:t.sdpMLineIndex,candidate:JSON.stringify(t.candidate)}})},onmessage:function(e){r({data:e,userid:t.userid,extra:t.extra})},onaddstream:function(n){if(w(e.session)&&m)return;if(t.streaminfo){var r=t.streaminfo.split("----");if(r[0]){n.streamid=r[0];delete r[0];t.streaminfo=E(r).join("----")}}var i=e.session;i.remote=true;var s=k(n,i);t.stream=n;if(s.tagName.toLowerCase()=="audio")s.addEventListener("play",function(){setTimeout(function(){s.muted=false;g(s)},3e3)},false);else p(s)},onremovestream:function(e){T("onremovestream",e)},onclose:function(n){n.extra=t.extra;n.userid=t.userid;e.onclose(n);if(e.channels[n.userid])delete e.channels[n.userid]},onerror:function(n){n.extra=t.extra;n.userid=t.userid;e.onerror(n)},oniceconnectionstatechange:function(e){S("oniceconnectionstatechange",N(e))},onsignalingstatechange:function(e){S("onsignalingstatechange",N(e))},attachStreams:e.attachStreams,iceServers:e.iceServers,bandwidth:e.bandwidth,sdpConstraints:e.sdpConstraints||{},disableDtlsSrtp:e.disableDtlsSrtp,preferSCTP:!!e.preferSCTP,onSessionDescription:function(e,t){x({sdp:e,socket:s,streaminfo:t})},socket:s,selfUserid:e.userid};e.playRoleOfInitiator=function(){e.dontAttachStream=true;e.open();l=E(l);e.dontAttachStream=false}}function b(t,n){if(!t)return;for(var r=0;r<t.length;r++){var i=t[r];if(e.streams[i]){n.removeStream(e.streams[i].stream)}}}function x(t){t.socket.send({userid:u.userid,sdp:JSON.stringify(t.sdp),extra:e.extra,renegotiate:!!t.renegotiate?t.renegotiate:false,streaminfo:t.streaminfo||"",labels:t.labels||[]})}function A(t){var n=t.newParticipant;if(!n||!!c[n]||n==u.userid)return;c[n]=n;var r=e.token();g({channel:r,extra:t.extra||{},userid:t.userid});P.send({participant:true,userid:u.userid,targetUser:n,channel:r,extra:e.extra})}function O(t){var n={left:true,extra:e.extra,userid:u.userid,sessionid:u.sessionid};if(e.isInitiator){if(e.autoCloseEntireSession){n.closeEntireSession=true}else if(l[0]){l[0].send({playRoleOfBroadcaster:true,userid:u.userid})}}if(!t){var r=l.length;for(var i=0;i<r;i++){socket=l[i];if(socket){socket.send(n);if(a[socket.channel])delete a[socket.channel];delete l[i]}}}if(t){socket=a[t];if(socket){n.ejected=true;socket.send(n);if(l[socket.index])delete l[socket.index];delete a[t]}}l=E(l)}function _(){P=e.openSignalingChannel({onmessage:function(t){if(t.userid==u.userid)return;if(h&&t.sessionid&&t.userid){e.session=t.session;s(t)}if(t.newParticipant&&u.joinedARoom&&u.broadcasterid===t.userid){A(t)}if(C(c)<e.maxParticipantsAllowed&&t.userid&&t.targetUser==u.userid&&t.participant&&!c[t.userid]){j(t.channel||t.userid,t.extra,t.userid)}if(t.userType&&t.userType!=e.userType){if(!e.busy){if(t.userType=="admin"){if(e.onAdmin)e.onAdmin(t);else e.accept(t.userid)}if(t.userType=="guest"){if(e.onGuest)e.onGuest(t);else e.accept(t.userid)}}else{if(t.userType!=e.userType){e.reject(t.userid)}}}if(t.acceptedRequestOf==u.userid){if(e.onstats)e.onstats("accepted",t)}if(t.rejectedRequestOf==u.userid){if(e.onstats)e.onstats(e.userType?"busy":"rejected",t);H()}if(t.customMessage){if(t.message.drop){e.ondrop(t.userid);e.attachStreams=[];for(var n in e.streams){if(e._skip.indexOf(n)==-1){n=e.streams[n];if(n.type=="local"){e.detachStreams.push(n.streamid);e.onstreamended(n.streamObject)}else e.onstreamended(n.streamObject)}}if(t.message.renegotiate){e.addStream()}}else if(e.onCustomMessage){e.onCustomMessage(t.message)}}},callback:function(t){if(t)P=t;if(e.userType)H(t||P)},onopen:function(t){if(t)P=t;if(e.userType)H(t||P)}})}function H(t){if(!t){return setTimeout(function(){H(P)},1e3)}t.send({userType:e.userType,userid:e.userid,extra:e.extra||{}})}function B(){if(e.direction=="one-way")e.session.oneway=true;if(e.direction=="one-to-one")e.maxParticipantsAllowed=1;if(e.direction=="one-to-many")e.session.broadcast=true;if(e.direction=="many-to-many"){if(!e.maxParticipantsAllowed||e.maxParticipantsAllowed==1){e.maxParticipantsAllowed=256}}}function j(t,n,r){if(!u.requestsFrom)u.requestsFrom={};if(e.busy||u.requestsFrom[r])return;var i={userid:r,extra:n,channel:t};u.requestsFrom[r]=i;if(e.onRequest){e.onRequest(i)}else F(i)}function F(t){if(e.userType){if(e.direction==="many-to-many")e.busy=true;P.send({acceptedRequestOf:t.userid,userid:u.userid,extra:e.extra||{}})}c[t.userid]=t.userid;g({isofferer:true,userid:t.userid,channel:t.channel,extra:t.extra||{}})}var t=new f(e);var n=new p(e);var u={};var a={};var l=[];u.userid=e.userid=e.userid||e.token();u.sessionid=e.channel;var c={};var h=true;e.remove=function(t){if(u.requestsFrom&&u.requestsFrom[t])delete u.requestsFrom[t];if(e.peers[t]){if(e.peers[t].peer&&e.peers[t].peer.connection){e.peers[t].peer.connection.close();e.peers[t].peer.connection=null}delete e.peers[t]}if(c[t]){delete c[t]}for(var n in e.streams){n=e.streams[n];if(n.userid==t){e.onstreamended(n.streamObject);if(n.stop)n.stop();delete e.streams[n]}}if(a[t]){delete a[t]}};e.refresh=function(){c=[];e.joinedARoom=u.joinedARoom=false;h=true;e.busy=false;for(var t=0;t<e.attachStreams.length;t++){M(e.attachStreams[t])}e.attachStreams=[];o={streams:[],mutex:false,queueRequests:[]};D.isOwnerLeaving=true;e.isInitiator=false};e.reject=function(t){if(typeof t!="string")t=t.userid;P.send({rejectedRequestOf:t,userid:e.userid,extra:e.extra||{}})};window.addEventListener("beforeunload",function(){O()},false);window.addEventListener("keydown",function(e){if(e.keyCode==116)O()},false);var D=this,P;_();this.initSession=function(){D.isOwnerLeaving=false;e.isInitiator=true;B();c={};u.sessionid=e.sessionid||e.channel;this.isOwnerLeaving=h=false;u.joinedARoom=true;(function t(){if(C(c)<e.maxParticipantsAllowed&&!D.isOwnerLeaving){P&&P.send({sessionid:u.sessionid,userid:e.userid,session:e.session,extra:e.extra})}if(!e.transmitRoomOnce&&!D.isOwnerLeaving)setTimeout(t,e.interval||3e3)})()};this.joinSession=function(t){t=t||{};c={};e.session=t.session;u.broadcasterid=t.userid;if(t.sessionid)u.sessionid=t.sessionid;h=false;u.joinedARoom=true;var n=y();g({channel:n,extra:t.extra||{},userid:t.userid});P.send({participant:true,userid:u.userid,channel:n,targetUser:t.userid,extra:e.extra})};this.send=function(t,n){t=JSON.stringify(t);if(n){if(n.readyState=="open"){n.send(t)}return}for(var r in e.channels){var i=e.channels[r].channel;if(i.readyState=="open"){i.send(t)}}};this.leave=function(t){O(t);if(e.isInitiator){D.isOwnerLeaving=true;e.isInitiator=false}for(var n=0;n<e.attachStreams.length;n++){M(e.attachStreams[n])}e.attachStreams=[];o={streams:[],mutex:false,queueRequests:[]};if(!t){e.joinedARoom=u.joinedARoom=false;h=true}e.busy=false};this.addStream=function(t){function r(n){var r=n.socket;if(!r){T(n,"doesn't has socket.");return}v(r);if(!n||!n.peer){throw"No peer to renegotiate."}n=n.peer;b(e.detachStreams,n.connection);if(t.stream&&(e.session.audio||e.session.video||e.session.screen)){n.connection.addStream(t.stream)}n.recreateOffer(e.session,function(t,n){x({sdp:t,socket:r,renegotiate:e.session,labels:e.detachStreams,streaminfo:n});e.detachStreams=[]})}e.session=t.renegotiate;if(t.socket){r(e.peers[t.socket.userid])}else{for(var n in e.peers){r(e.peers[n])}}};e.request=function(t,n){if(e.direction==="many-to-many")e.busy=true;e.captureUserMedia(function(){g({channel:e.userid,extra:n||{},userid:t});P.send({participant:true,userid:e.userid,extra:e.extra||{},targetUser:t})})};e.sendCustomMessage=function(t){if(!P){return setTimeout(function(){e.sendMessage(t)},1e3)}P.send({userid:e.userid,customMessage:true,message:t})};e.accept=function(t){if(arguments.length>1&&typeof arguments[0]=="string"){t={};if(arguments[0])t.userid=arguments[0];if(arguments[1])t.extra=arguments[1];if(arguments[2])t.channel=arguments[2]}e.captureUserMedia(function(){F(t)})}}function i(){return{create:function(e,t){L(this,t);var n=this;this.type=e;this.init();this.attachMediaStreams();if(w(this.session)&&m){navigator.mozGetUserMedia({audio:true,fake:true},function(t){n.connection.addStream(t);if(e=="offer"){n.createDataChannel()}n.getLocalDescription(e);if(e=="answer"){n.createDataChannel()}},this.onMediaError)}if(!w(this.session)&&m){if(this.session.data&&e=="offer"){this.createDataChannel()}this.getLocalDescription(e);if(this.session.data&&e=="answer"){this.createDataChannel()}}v&&n.getLocalDescription(e);return this},getLocalDescription:function(e){S("peer type is",e);if(e=="answer"){this.setRemoteDescription(this.offerDescription)}var t=this;this.connection[e=="offer"?"createOffer":"createAnswer"](function(e){e.sdp=t.serializeSdp(e.sdp);t.connection.setLocalDescription(e);t.onSessionDescription(e,t.streaminfo)},this.onSdpError,this.constraints)},serializeSdp:function(e){e=this.setBandwidth(e);if(this.hold){e=e.replace(/sendonly|recvonly|sendrecv/g,"inactive")}else if(this.prevSDP){e=e.replace(/inactive/g,"sendrecv")}return e},init:function(){this.setConstraints();this.connection=new t(this.iceServers,this.optionalArgument);if(this.session.data&&v){this.createDataChannel()}this.connection.onicecandidate=function(t){if(t.candidate){e.onicecandidate(t.candidate)}};this.connection.onaddstream=function(t){S("onaddstream",t.stream);e.onaddstream(t.stream)};this.connection.onremovestream=function(t){e.onremovestream(t.stream)};this.connection.onsignalingstatechange=function(){e.connection&&e.oniceconnectionstatechange({iceGatheringState:e.connection.iceGatheringState,signalingState:e.connection.signalingState})};this.connection.oniceconnectionstatechange=function(){e.connection&&e.oniceconnectionstatechange({iceGatheringState:e.connection.iceGatheringState,signalingState:e.connection.signalingState})};var e=this},setBandwidth:function(e){if(g||m||!this.bandwidth)return e;var t=this.bandwidth;if(t.audio||t.video||t.data){e=e.replace(/b=AS([^\r\n]+\r\n)/g,"")}if(t.audio){e=e.replace(/a=mid:audio\r\n/g,"a=mid:audio\r\nb=AS:"+t.audio+"\r\n")}if(t.video){e=e.replace(/a=mid:video\r\n/g,"a=mid:video\r\nb=AS:"+(this.session.screen?"300":t.video)+"\r\n")}if(t.data&&!this.preferSCTP){e=e.replace(/a=mid:data\r\n/g,"a=mid:data\r\nb=AS:"+t.data+"\r\n")}return e},setConstraints:function(){this.constraints={optional:[],mandatory:{OfferToReceiveAudio:!!this.session.audio,OfferToReceiveVideo:!!this.session.video||!!this.session.screen}};S("sdp-constraints",N(this.constraints.mandatory));this.optionalArgument={optional:[{DtlsSrtpKeyAgreement:true}]};if(v&&b>=32){this.optionalArgument.optional.push({googIPv6:true})}if(!this.preferSCTP){this.optionalArgument={optional:[{RtpDataChannels:true}]}}S("optional-argument",N(this.optionalArgument.optional));var e=[];if(m){e.push({url:"stun:23.21.150.121"});e.push({url:"stun:stun.services.mozilla.com"})}if(v){e.push({url:"stun:stun.l.google.com:19302"});e.push({url:"stun:stun.anyfirewall.com:3478"})}if(v&&b<28){e.push({url:"turn:homeo@turn.bistri.com:80",credential:"homeo"})}if(v&&b>=28){e.push({url:"turn:turn.bistri.com:80",credential:"homeo",username:"homeo"})}this.iceServers={iceServers:e};S("ice-servers",N(this.iceServers.iceServers))},onSdpError:function(e){var t=N(e);if(t&&t.indexOf("RTP/SAVPF Expects at least 4 fields")!=-1){t="It seems that you are trying to interop RTP-datachannels with SCTP. It is not supported!"}x("onSdpError:",t)},onMediaError:function(e){x(N(e))},setRemoteDescription:function(e){if(!e)throw"Remote session description should NOT be NULL.";S("setting remote description",e);this.connection.setRemoteDescription(new n(e))},addIceCandidate:function(e){this.connection.addIceCandidate(new r({sdpMLineIndex:e.sdpMLineIndex,candidate:e.candidate}))},createDataChannel:function(e){if(!this.channels)this.channels=[];var t={};if(v&&!this.preferSCTP){t.reliable=false}if(m){this.connection.onconnection=function(){n.socket.send({userid:n.selfUserid,isCreateDataChannel:true})}}if(this.type=="answer"||m){this.connection.ondatachannel=function(e){n.setChannelEvents(e.channel)}}if(v&&this.type=="offer"||m){this.setChannelEvents(this.connection.createDataChannel(e||"channel",t))}var n=this},setChannelEvents:function(e){var t=this;e.onmessage=function(e){t.onmessage(e.data)};e.onopen=function(){e.push=e.send;e.send=function(t){if(e.readyState!="open"){return setTimeout(function(){e.send(t)},1e3)}try{e.push(t)}catch(n){T("Data transmission failed. Re-transmitting..");return setTimeout(function(){e.send(t)},100)}};t.onopen(e)};e.onerror=function(e){t.onerror(e)};e.onclose=function(e){t.onclose(e)};this.channels.push(e)},attachMediaStreams:function(){var e=this.attachStreams;for(var t=0;t<e.length;t++){S("attaching stream:",e[t].streamid);this.connection.addStream(e[t])}this.attachStreams=[];this.getStreamInfo()},getStreamInfo:function(){this.streaminfo="";var e=this.connection.getLocalStreams();for(var t=0;t<e.length;t++){if(t==0){this.streaminfo=e[t].streamid}else{this.streaminfo+="----"+e[t].streamid}}},recreateOffer:function(e,t){S("recreating offer");this.type="offer";this.renegotiate=true;this.session=e;this.setConstraints();this.onSessionDescription=t;this.getStreamInfo();if(this.session.data&&v){this.createDataChannel()}this.getLocalDescription("offer")},recreateAnswer:function(e,t,n){S("recreating answer");this.type="answer";this.renegotiate=true;this.session=t;this.setConstraints();this.onSessionDescription=n;this.offerDescription=e;this.getStreamInfo();if(this.session.data&&v){this.createDataChannel()}this.getLocalDescription("answer")}}}function u(e){function c(t,n){var r=e.video;if(r){r[m?"mozSrcObject":"src"]=m?t:window.webkitURL.createObjectURL(t);r.play()}e.onsuccess(t,n,l);o.streams[l]=t;o.mutex=false;if(o.queueRequests.length)u(o.queueRequests.shift())}if(o.mutex===true){o.queueRequests.push(e);return}o.mutex=true;var t=e.mediaConstraints||{};var n=navigator,r=e.constraints||{audio:true,video:s};if(r.video==true)r.video=s;if(typeof t.audio!="undefined")r.audio=t.audio;var i=e.media;if(v){var a={minWidth:i.minWidth,minHeight:i.minHeight,maxWidth:i.maxWidth,maxHeight:i.maxHeight,minAspectRatio:i.minAspectRatio};var f=["1920:1080","1280:720","960:720","640:360","640:480","320:240","320:180"];if(f.indexOf(a.minWidth+":"+a.minHeight)==-1||f.indexOf(a.maxWidth+":"+a.maxHeight)==-1){x('The min/max width/height constraints you passed "seems" NOT supported.',N(a))}if(a.minWidth>a.maxWidth||a.minHeight>a.maxHeight){x("Minimum value must not exceed maximum value.",N(a))}if(a.minWidth>=1280&&a.minHeight>=720){T("Enjoy HD video! min/"+a.minWidth+":"+a.minHeight+", max/"+a.maxWidth+":"+a.maxHeight)}r.video.mandatory=L(r.video.mandatory,a)}if(t.mandatory)r.video.mandatory=L(r.video.mandatory,t.mandatory);if(t.optional)r.video.optional[0]=L({},t.optional);S("media hints:",N(r));var l=JSON.stringify(r);if(o.streams[l]){c(o.streams[l],true)}else{n.getMedia=n.webkitGetUserMedia||n.mozGetUserMedia;n.getMedia(r,c,e.onerror||function(e){x(N(e))})}}function f(e){function i(i){var s=i.uuid;if(typeof i.packets!=="undefined"){r[s]=n[s]=parseInt(i.packets);e.onFileStart(i)}e.onFileProgress({remaining:n[s]--,length:r[s],received:r[s]-n[s],maxChunks:r[s],uuid:s,currentPosition:r[s]-n[s]},s);if(!t[s])t[s]=[];t[s].push(i.message);if(i.last){var o=t[s].join("");c.DataURLToBlob(o,i.fileType,function(n){n.uuid=s;n.name=i.name;n.type=i.fileType;n.extra=i.extra||{};n.url=(window.URL||window.webkitURL).createObjectURL(n);if(e.autoSaveToDisk){l.SaveToDisk(n.url,i.name)}e.onFileEnd(n);delete t[s]})}}var t={},n={},r={};return{receive:i}}function p(e){function n(n,r,i){var s=n.uuid;if(!t[s])t[s]=[];t[s].push(n.message);if(n.last){var o=t[s].join("");if(n.isobject)o=JSON.parse(o);var u=(new Date).getTime();var a=u-n.sendingTime;var f={data:o,userid:r,extra:i,latency:a};if(e.autoTranslateText){f.original=f.data;e.Translator.TranslateText(f.data,function(t){f.data=t;e.onmessage(f)})}else e.onmessage(f);delete t[s]}}var t={};return{receive:n}}function d(e){var t=e.root;var n=e.context;this.context=n;this.volume=0;this.slow_volume=0;this.clip=0;this.script=n.createScriptProcessor(256,1,1);that=this;this.script.onaudioprocess=function(n){var r=n.inputBuffer.getChannelData(0);var i;var s=0;var o=0;for(i=0;i<r.length;++i){s+=r[i]*r[i];if(Math.abs(r[i])>.99){o+=1}}that.volume=Math.sqrt(s/r.length);var u=that.volume.toFixed(2);if(u>=.1&&t.onspeaking){t.onspeaking(e.event)}if(u<.1&&t.onsilence){t.onsilence(e.event)}}}function y(){return(Math.random()*(new Date).getTime()).toString(36).replace(/\./g,"")}function w(e){return!e.audio&&!e.video&&!e.screen&&e.data}function E(e){var t=[],n=e.length;for(var r=0;r<n;r++)if(e[r]&&e[r]!==true)t.push(e[r]);return t}function S(){if(window.skipRTCMultiConnectionLogs)return;console.log(Array.prototype.slice.call(arguments).join("\n"))}function x(){console.error(Array.prototype.slice.call(arguments).join("\n"))}function T(){if(window.skipRTCMultiConnectionLogs)return;console.warn(Array.prototype.slice.call(arguments).join("\n"))}function N(e){return JSON.stringify(e,function(e,t){if(t&&t.sdp){console.log(t.sdp.type,"	",t.sdp.sdp);return""}else return t},"	")}function C(e){var t=0;for(var n in e)if(n)t++;return t}function k(e,t){var n=t.audio&&!t.video&&!t.screen;if(v&&e.getAudioTracks&&e.getVideoTracks){n=e.getAudioTracks().length&&!e.getVideoTracks().length}var r=document.createElement(n?"audio":"video");r[m?"mozSrcObject":"src"]=m?e:window.webkitURL.createObjectURL(e);r.controls=true;r.autoplay=!!t.remote;r.volume=t.remote?1:0;if(!t.remote){r.muted=true}r.play();return r}function L(e,t){if(!e)e={};if(!t)return e;for(var n in t){e[n]=t[n]}return e}function A(e,t){var n=document.createElement("script");n.src=e;if(t)n.onload=t;document.documentElement.appendChild(n)}function O(e){var t=e.stream,n=e.root,r=e.session||{},i=e.enabled;if(!r.audio&&!r.video){r=L(r,{audio:true,video:true})}if(r.type){if(r.type=="remote"&&n.type!="remote")return;if(r.type=="local"&&n.type!="local")return}S("session",JSON.stringify(r,null,"	"));if(r.audio){var s=t.getAudioTracks()[0];if(s)s.enabled=!i}if(r.video){var o=t.getVideoTracks()[0];if(o)o.enabled=!i}if(n.socket){if(n.type=="local")n.socket.send({userid:n.rtcMultiConnection.userid,streamid:n.streamid,mute:!!i,unmute:!i,session:r});if(n.type=="remote")n.socket.send({userid:n.rtcMultiConnection.userid,promptMuteUnmute:true,streamid:n.streamid,mute:!!i,unmute:!i,session:r})}n.streamObject.session=r;if(!!i){n.rtcMultiConnection.onmute(n.streamObject)}if(!i){n.rtcMultiConnection.onunmute(n.streamObject)}}function M(e){if((!e.getAudioTracks||!e.getVideoTracks)&&e.stop){e.stop();return}var t=false,n;var r=e.getAudioTracks();var i=e.getVideoTracks();for(n=0;n<r.length;n++){if(r[n].stop){try{r[n].stop()}catch(s){t=true;continue}}else{t=true;continue}}for(n=0;n<i.length;n++){if(i[n].stop){try{i[n].stop()}catch(s){t=true;continue}}else{t=true;continue}}if(t&&e.stop)e.stop()}function _(e){function r(e,t){if(e.position==-1)return;var n=+e.position.toFixed(2).split(".")[1]||100;t.innerHTML=n+"%"}e.onmessage=function(e){S("onmessage",N(e))};e.onopen=function(e){S("Data connection is opened between you and",e.userid)};e.onerror=function(e){x(onerror,N(e))};e.onclose=function(e){T("onclose",N(e))};var n={};e.body=document.body;e.autoSaveToDisk=false;e.onFileStart=function(t){var r=document.createElement("div");r.title=t.name;r.innerHTML="<label>0%</label> <progress></progress>";e.body.insertBefore(r,e.body.firstChild);n[t.uuid]={div:r,progress:r.querySelector("progress"),label:r.querySelector("label")};n[t.uuid].progress.max=t.maxChunks};e.onFileProgress=function(e){var t=n[e.uuid];if(!t)return;t.progress.value=e.currentPosition||e.maxChunks||t.progress.max;r(t.progress,t.label)};e.onFileEnd=function(t){if(n[t.uuid])n[t.uuid].div.innerHTML='<a href="'+t.url+'" target="_blank" download="'+t.name+'">'+t.name+"</a>";if(e.onFileSent||e.onFileReceived){T('Now, "autoSaveToDisk" is false. Read more here: http://www.RTCMultiConnection.org/docs/autoSaveToDisk/');if(e.onFileSent)e.onFileSent(t,t.uuid);if(e.onFileReceived)e.onFileReceived(t.name,t)}};e.dontAttachStream=false;e.onstream=function(t){e.body.insertBefore(t.mediaElement,e.body.firstChild)};e.onstreamended=function(e){if(e.mediaElement&&e.mediaElement.parentNode){e.mediaElement.parentNode.removeChild(e.mediaElement)}};e.onmute=function(e){if(e.session.video){e.mediaElement.setAttribute("poster","//www.webrtc-experiment.com/images/muted.png")}};e.onunmute=function(e){if(e.session.video){e.mediaElement.removeAttribute("poster")}};e.onleave=function(e){S("onleave",N(e))};e.token=function(){if(window.crypto){var e=window.crypto.getRandomValues(new Uint32Array(3)),t="";for(var n=0,r=e.length;n<r;n++)t+=e[n].toString(36);return t}else{return(Math.random()*(new Date).getTime()).toString(36).replace(/\./g,"")}};e.userid=e.token();e.peers={};e.peers[e.userid]={drop:function(){e.drop()}};e._skip=["stop","mute","unmute","_private"];e.streams={mute:function(e){this._private(e,true)},unmute:function(e){this._private(e,false)},_private:function(t,n){for(var r in this){if(e._skip.indexOf(r)==-1){this[r]._private(t,n)}}},stop:function(e){var t;for(var n in this){if(n!="stop"&&n!="mute"&&n!="unmute"&&n!="_private"){t=this[n];if(!e)t.stop();if(e=="local"&&t.type=="local")t.stop();if(e=="remote"&&t.type=="remote")t.stop()}}}};e.channels={};e.extra={};e.session={audio:true,video:true};e.bandwidth={};e.preferSCTP=true;e.fileQueue={};e.media={min:function(e,t){this.minWidth=e;this.minHeight=t},minWidth:640,minHeight:360,max:function(e,t){this.maxWidth=e;this.maxHeight=t},maxWidth:1280,maxHeight:720,bandwidth:256,minFrameRate:1,maxFrameRate:30,minAspectRatio:1.77};e.candidates={host:true,relay:true,reflexive:true};e.mediaConstraints={};e.sdpConstraints={};e.attachStreams=[];e.detachStreams=[];e.maxParticipantsAllowed=256;e.direction="many-to-many";e._getStream=function(e){return{rtcMultiConnection:e.rtcMultiConnection,streamObject:e.streamObject,stream:e.stream,userid:e.userid,streamid:e.streamid,socket:e.socket,type:e.type,mediaElement:e.mediaElement,stop:function(){if(this.socket){if(this.type=="local")this.socket.send({userid:this.rtcMultiConnection.userid,streamid:this.streamid,stopped:true});if(this.type=="remote")this.socket.send({userid:this.rtcMultiConnection.userid,promptStreamStop:true,streamid:this.streamid})}var e=this.stream;if(e&&e.stop){M(e)}},mute:function(e){this._private(e,true)},unmute:function(e){this._private(e,false)},_private:function(e,t){O({root:this,session:e,enabled:t,stream:this.stream})},startRecording:function(e){if(!e)e={audio:true,video:true};if(!window.RecordRTC){var t=this;return A("//www.webrtc-experiment.com/RecordRTC.js",function(){t.startRecording(e)})}this.recorder=new MRecordRTC;this.recorder.mediaType=e;this.recorder.addStream(this.stream);this.recorder.startRecording()},stopRecording:function(e){this.recorder.stopRecording();this.recorder.getBlob(function(t){e(t.audio||t.video,t.video)})}}};e.set=function(e){for(var t in e){this[t]=e[t]}return this};e.firebase="rtcweb";e.onMediaError=function(e){x(e)};e.stats={};e.getStats=function(e){var t=0;for(var n in this.peers){t++}this.stats.numberOfConnectedUsers=t;if(e)e(this.stats)};e.caniuse={RTCPeerConnection:!!t,getUserMedia:!!u,AudioContext:!!AudioContext,ScreenSharing:v&&b>=26&&location.protocol=="https:",checkIfScreenSharingFlagEnabled:function(e){function s(t){if(t.stop){t.stop()}if(e){e(true)}}function o(){i=true;if(e)e(r>5,t)}var t;if(m){t="Screen sharing is NOT supported on Firefox.";x(t);if(e)e(false)}if(location.protocol!=="https:"){t="Screen sharing is NOT supported on "+location.protocol+" Try https!";x(t);if(e)return e(false)}if(b<26){t="Screen sharing support is suspicious!";T(t)}var n={video:{mandatory:{chromeMediaSource:"screen"}}};var r=0,i;(function u(){r++;if(!i)setTimeout(u,10)})();navigator.webkitGetUserMedia(n,s,o)},RtpDataChannels:v&&b>=25,SctpDataChannels:v&&b>=31};e.snapshots={};e.takeSnapshot=function(e,t){for(var n in this.streams){n=this.streams[n];if(n.userid==e){var r=n.streamObject.mediaElement;var i=document.createElement("canvas");i.width=r.videoWidth||r.clientWidth;i.height=r.videoHeight||r.clientHeight;var s=i.getContext("2d");s.drawImage(r,0,0,i.width,i.height);this.snapshots[e]=i.toDataURL();t&&t(this.snapshots[e]);continue}}};e.saveToDisk=function(e,t){if(e.size&&e.type)l.SaveToDisk(URL.createObjectURL(e),t||e.name||e.type.replace("/","-")+e.type.split("/")[1]);else l.SaveToDisk(e,t)};e._mediaSources={};e.selectDevices=function(t,n){function r(t){if(!t)return;e._mediaSources[t.kind]=t.id}if(t)r(this.devices[t]);if(n)r(this.devices[n])};e.devices={};e.getDevices=function(t){if(!!window.MediaStreamTrack&&!!MediaStreamTrack.getSources){MediaStreamTrack.getSources(function(n){var i=[];for(var s=0;s<n.length;s++){i.push(n[s])}r(i);if(t)t(e.devices)});var n=0;function r(t){var i=t[n];if(!i)return;e.devices[i.id]=i;n++;r(t)}}};e.onCustomMessage=function(e){S("Custom message",e)};e.ondrop=function(e){S("Media connection is dropped by "+e)};e.drop=function(e){e=e||{};this.attachStreams=[];for(var t in this.streams){if(this._skip.indexOf(t)==-1){t=this.streams[t];if(t.type=="local"){this.detachStreams.push(t.streamid);this.onstreamended(t.streamObject)}else this.onstreamended(t.streamObject)}}this.sendCustomMessage({drop:true,dontRenegotiate:typeof e.renegotiate=="undefined"?true:e.renegotiate})};if(!!window.AudioContext){e._audioContext=new AudioContext}e.language="en";e.autoTranslateText=false;e.googKey="AIzaSyCUmCjvKRb-kOYrnoL2xaXb8I-_JJeKpf0";e.Translator={TranslateText:function(t,n){var r=document.createElement("script");r.type="text/javascript";var i=encodeURIComponent(t);var s="method"+e.token();window[s]=function(e){if(e.data&&e.data.translations[0]&&n){n(e.data.translations[0].translatedText)}};var o="https://www.googleapis.com/language/translate/v2?key="+e.googKey+"&target="+(e.language||"en-US")+"&callback=window."+s+"&q="+i;r.src=o;document.getElementsByTagName("head")[0].appendChild(r)}}}window.RTCMultiConnection=function(t){function i(e){if(n.openSignalingChannel)return e();if(!window.Firebase){return A("//www.webrtc-experiment.com/firebase.js",function(){i(e)})}var r={};var s=new Firebase("//"+n.firebase+".firebaseio.com/"+n.channel);s.on("child_added",function(e){var t=e.val();if(t.sender==n.userid)return;if(r[t.channel]){r[t.channel](t.message)}e.ref().remove()});n.openSignalingChannel=function(e){var i=e.channel||n.channel;r[i]=e.onmessage;if(e.onopen)setTimeout(e.onopen,1e3);return{send:function(e){s.push({sender:n.userid,channel:i,message:e})},channel:t}};s.onDisconnect().remove();e()}function s(){if(r)return;r=new e(n)}function f(e){if(!e||!e.userid||!e.sessionid)throw'invalid data passed over "join" method';n.session=e.session;extra=n.extra||e.extra||{};if(e.oneway||e.data){r.joinSession(e,extra)}else{l(function(){r.joinSession(e,extra)})}}function l(e,t){function a(e,t,s){var a={onsuccess:function(e,i,u){if(i)return t&&t(e);if(s&&v){e=new window.webkitMediaStream(e.getAudioTracks())}var a=k(e,r);a.muted=true;e.onended=function(){n.onstreamended(l);var e=n.streams[f];if(e&&e.socket){e.socket.send({userid:n.userid,streamid:e.streamid,stopped:true})}if(o.streams[u]){delete o.streams[u]}};var f=y();e.streamid=f;var l={stream:e,streamid:f,mediaElement:a,blobURL:a.mozSrcObject||a.src,type:"local",userid:n.userid||"self",extra:n.extra};var c={stream:e,userid:n.userid||"self",streamid:f,type:"local",streamObject:l,mediaElement:a,rtcMultiConnection:n};n.attachStreams.push(e);n.__attachStreams.push(c);n.streams[f]=n._getStream(c);n.onstream(l);if(t)t(e);if(n.onspeaking){var h=new d({context:n._audioContext,root:n,event:l});h.connectToSource(e)}},onerror:function(e){n.onMediaError(N(e));if(r.audio){n.onMediaError("Maybe microphone access is denied.")}if(r.video){n.onMediaError("Maybe webcam access is denied.")}if(r.screen){if(m){n.onMediaError("Firefox has not yet released their screen capturing modules. Still work in progress! Please try chrome for now!")}else if(location.protocol!=="https:"){n.onMediaError("<https> is mandatory to capture screen.")}else{n.onMediaError("Unable to detect actual issue. Trying to check availability of screen sharing flag.");n.caniuse.checkIfScreenSharingFlagEnabled(function(e,t){if(e){if(b<31){n.onMediaError("Multi-capturing of screen is not allowed. Capturing process is denied. Try chrome >= M31.")}else{n.onMediaError("Unknown screen capturing error.")}}if(t)n.onMediaError(t);if(!t){n.onMediaError('It seems that "chrome://flags/#enable-usermedia-screen-capture" flag is not enabled.')}})}}},mediaConstraints:n.mediaConstraints||{}};a.constraints=e||i;a.media=n.media;u(a)}var r=t||n.session;if(n.dontAttachStream)return e();if(w(r)||!n.isInitiator&&r.oneway){n.attachStreams=[];return e()}var i={audio:!!r.audio,video:!!r.video};if(n._mediaSources.audio){i.audio={optional:[{sourceId:n._mediaSources.audio}]}}if(n._mediaSources.video){i.video={optional:[{sourceId:n._mediaSources.video}]}}var s={audio:false,video:{mandatory:{chromeMediaSource:"screen"},optional:[]}};if(r.screen){a(s,i.audio||i.video?function(){a(i,e)}:e)}else a(i,e,r.audio&&!r.video)}this.channel=t||location.href.replace(/\/|:|#|%|\.|\[|\]/g,"");this.open=function(e){n.joinedARoom=true;if(e)n.channel=e;if(n.socket&&n.socket.onDisconnect)n.socket.onDisconnect().remove();n.isInitiator=true;i(function(){s();l(r.initSession)})};this.connect=function(e){if(e)n.channel=e;i(s);return this};this.join=f;this.send=function(e,t){if(!e)throw"No file, data or text message to share.";if(!!e.forEach){for(var i=0;i<e.length;i++){n.send(e[i],t)}return}if(typeof e.size!="undefined"&&typeof e.type!="undefined"){a.send({file:e,channel:r,_channel:t,root:n})}else{h.send({text:e,channel:r,_channel:t,preferSCTP:n.preferSCTP})}};var n=this;var r;this.captureUserMedia=l;this.leave=function(e){r.leave(e);if(!e){var t=n.attachStreams;for(var i=0;i<t.length;i++){M(t[i])}o.streams=[];n.attachStreams=[]}if(n.isInitiator&&!!n.socket&&!!n.socket.remove){n.socket.remove()}};this.eject=function(e){if(!connection.isInitiator)throw"Only session-initiator can eject a user.";this.leave(e)};this.close=function(){n.autoCloseEntireSession=true;r.leave()};this.renegotiate=function(e){r.addStream({renegotiate:{oneway:true,audio:true,video:true},stream:e})};this.addStream=function(e,t){function s(i){r.addStream({stream:i,renegotiate:e||n.session,socket:t})}if(e){var i;if(!n.isInitiator&&e.oneway){e.oneway=false;i=true}l(function(t){if(i){e.oneway=true}s(t)},e)}else s()};this.removeStream=function(e){if(!this.streams[e])return T("No such stream exists. Stream-id:",e);this.detachStreams.push(e)};_(this);this.__attachStreams=[]};var t=window.mozRTCPeerConnection||window.webkitRTCPeerConnection;var n=window.mozRTCSessionDescription||window.RTCSessionDescription;var r=window.mozRTCIceCandidate||window.RTCIceCandidate;var s={mandatory:{},optional:[]};var o={streams:[],mutex:false,queueRequests:[]};var a={send:function(e){function f(){var e=URL.createObjectURL(new Blob(["function readFile(_file) {postMessage(new FileReaderSync().readAsDataURL(_file));};this.onmessage =  function (e) {readFile(e.data);}"],{type:"application/javascript"}));var t=new Worker(e);URL.revokeObjectURL(e);return t}function h(e,f){var l={type:"file",uuid:i.uuid,maxChunks:u,currentPosition:u-a,name:i.name,fileType:i.type,size:i.size};if(e){f=e;u=a=l.packets=parseInt(f.length/s);i.maxChunks=l.maxChunks=u;l.currentPosition=u-a;t.onFileStart(i)}t.onFileProgress({remaining:a--,length:u,sent:u-a,maxChunks:u,uuid:i.uuid,currentPosition:u-a},i.uuid);if(f.length>s)l.message=f.slice(0,s);else{l.message=f;l.last=true;l.name=i.name;l.extra=t.extra||{};i.url=URL.createObjectURL(i);t.onFileEnd(i)}n.send(l,r);o=f.slice(l.message.length);if(o.length){setTimeout(function(){h(null,o)},t.chunkInterval||100)}}var t=e.root;var n=e.channel;var r=e._channel;var i=e.file;if(!e.file){console.error("You must attach/select a file.");return}var s=!!navigator.mozGetUserMedia||t.preferSCTP?15*1e3:1*1e3;if(t.chunkSize){s=t.chunkSize}var o="";var u=0;var a=0;i.uuid=y();if(!!window.Worker&&!g){var l=f();l.onmessage=function(e){h(e.data)};l.postMessage(i)}else{var c=new FileReader;c.onload=function(e){h(e.target.result)};c.readAsDataURL(i)}}};var l={SaveToDisk:function(e,t){var n=document.createElement("a");n.href=e;n.target="_blank";n.download=t||e;var r=new MouseEvent("click",{view:window,bubbles:true,cancelable:true});n.dispatchEvent(r);(window.URL||window.webkitURL).revokeObjectURL(n.href)}};var c={DataURLToBlob:function(e,t,n){function r(){var e=URL.createObjectURL(new Blob(['function getBlob(_dataURL, _fileType) {var binary = atob(_dataURL.substr(_dataURL.indexOf(",") + 1)),i = binary.length,view = new Uint8Array(i);while (i--) {view[i] = binary.charCodeAt(i);};postMessage(new Blob([view], {type: _fileType}));};this.onmessage =  function (e) {var data = JSON.parse(e.data); getBlob(data.dataURL, data.fileType);}'],{type:"application/javascript"}));var t=new Worker(e);URL.revokeObjectURL(e);return t}if(!!window.Worker&&!g){var i=r();i.onmessage=function(e){n(e.data)};i.postMessage(JSON.stringify({dataURL:e,fileType:t}))}else{var s=atob(e.substr(e.indexOf(",")+1)),o=s.length,u=new Uint8Array(o);while(o--){u[o]=s.charCodeAt(o)}n(new Blob([u]))}}};var h={send:function(e){function f(r,l){var c={type:"text",uuid:u,sendingTime:a};if(r){l=r;c.packets=parseInt(l.length/i)}if(l.length>i)c.message=l.slice(0,i);else{c.message=l;c.last=true;c.isobject=o}t.send(c,n);s=l.slice(c.message.length);if(s.length){if(e.preferSCTP||m){setTimeout(function(){f(null,s)},100)}else{setTimeout(function(){f(null,s)},500)}}}var t=e.channel,n=e._channel,r=e.text,i=1e3,s="",o=false;if(typeof r!=="string"){o=true;r=JSON.stringify(r)}var u=y();var a=(new Date).getTime();f(r)}};d.prototype.connectToSource=function(e){this.mic=this.context.createMediaStreamSource(e);this.mic.connect(this.script);this.script.connect(this.context.destination)};d.prototype.stop=function(){this.mic.disconnect();this.script.disconnect()};var v=!!navigator.webkitGetUserMedia;var m=!!navigator.mozGetUserMedia;var g=navigator.userAgent.match(/Android|iPhone|iPad|iPod|BlackBerry|IEMobile/i);window.MediaStream=window.MediaStream||window.webkitMediaStream;window.AudioContext=window.AudioContext||window.webkitAudioContext;var b=!!navigator.mozGetUserMedia?0:parseInt(navigator.userAgent.match(/Chrom(e|ium)\/([0-9]+)\./)[2])})()

